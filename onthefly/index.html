<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>Railway Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="https://unpkg.com/deck.gl@^8.1.0/dist.min.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
<script type="text/javascript">
  const {MapboxLayer, ScatterplotLayer, PathLayer, TerrainLayer, PolygonLayer} = deck;
</script>
<script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
<script src='./getGeojson.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
<style>
body { margin:0; padding:0; }
#map {
  position: absolute;
  top: 10em;
  left: 0.5em;
  height: 400px;
  width: 300px;
}
#menu {
    position: absolute;
    left:  0.5em;
    top: 0.5em; 
    padding: 0.2em 0.5em;
    margin: 0 0;
    background: #eeeeee;
    box-shadow: 0px 0px 0px 5px #eeeeee;
    border: dashed 3px #dddddd;
    font-family: 'Open Sans', sans-serif;
    width: 90%;
    max-width: 280px;
}
button.local {
  display: block;
  text-align:center;
  background: #dddddd;
  padding 0 0.5em 0 0.5em;
  border: solid 2px #ddd;
  border-radius: 3px;
  margin: 0px 0px 5px 0px;
  line-height: 1.5em;
  font-size: 1em;
  width: 100%;
}

</style>
</head>
<body>


<div id='map'></div>
<div id='menu'>
  <button type="button" class="local" name="colchange" onclick="action()" >3D</button>
  <button type="button" class="local" name="colchange" onclick="addTerrain()" >地形表示</button>
</div>
<script>

/*************************************************/
/*Mapbox 関係設定                                */
/*************************************************/
var map = new mapboxgl.Map({
  container: 'map', // container id
  hash: true, //add #position on URL
  style: './style.json', // stylesheet location
  center: [139.78148, 35.768793], // starting position [lng, lat]
  zoom: 9, // starting zoom
  minZoom: 6,
  maxZoom: 17.99,
  localIdeographFontFamily: ['MS Gothic', 'Hiragino Kaku Gothic Pro', 'sans-serif']
});


map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
map.addControl(new mapboxgl.ScaleControl() );


/*************************************************/
/*DeckGL 関係設定                                */
/*************************************************/
/*************************************************/
/*データ取得 関係設定                            */
/*************************************************/

map.on('load', function(){
  map.addSource('building3d', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: []
      }
  });

  map.addSource('waterarea3d', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: []
      }
  });
});


var action = function(){
    
    //データの読み込みと加工
    var contour = getGeojson("LineString", "contour", "gsibv-vectortile-source-1-4-16").contests3d;
    var road = getGeojson("LineString", "road", "gsibv-vectortile-source-1-4-16").contests3d;
    var railway = getGeojson("LineString", "railway", "gsibv-vectortile-source-1-4-16").contests3d;
    var building = getGeojson("Polygon", "building", "gsibv-vectortile-source-1-4-16").geojson;
//    var waterarea = getGeojson("Polygon", "waterarea", "gsibv-vectortile-source-1-4-16").geojson;
    
    
    //道路データの加工
    for(i in road){

        var f = road[i];
        
        var color = [255,255,255];
        if(f.properties["motorway"] == 1){
          color = [100,195,115];
        }else if (f.properties["rdCtg"] == 0 || f.properties["rdCtg"] == 3){
          color = [235,130,120];
        }else if (f.properties["rdCtg"] == 1){
          color = [255,255,100];
        }
        
        var width = 1;
        if(f.properties["rnkWidth"] < 5){
          width = 1 + f.properties["rnkWidth"];
        }
        
        road[i].properties["color"] = color;
        road[i].properties["width"] = width;
        
        for(j in road[i].path){
          road[i].path[j][2] = road[i].path[j][2] + 5; //見た目の関係で少し高くする。
        }
        
    }
    
    //建物データの加工
    for(i in building.features){
        
        var f = building.features[i];
        
        var height = f.properties["alti"];
        
        var ftCode = f.properties["ftCode"];
        if(ftCode == 3101 || ftCode == 3111 || ftCode == 4302){
          height = height + 20;
        }else if(ftCode == 3102 || ftCode == 3112){
          height = height + 50;
        }else if(ftCode == 3103 || ftCode == 4301){
          height = height + 50;
        }
        
        building.features[i].properties["height"] = height;
        building.features[i].properties["baseHeight"] = f.properties["alti"];
        
    }
    
    //FillExtrusion利用--------------------------------------------------
    //建物
    if(building){
      if(map.getLayer('building-fillextrusion')){
          map.removeLayer('building-fillextrusion');
      }
      map.getSource('building3d').setData(
          building
      );
      map.addLayer({
          id: 'building-fillextrusion',
          type: 'fill-extrusion',
          source: 'building3d',
          paint: {
            'fill-extrusion-color': 'rgb(255, 200, 200)',
            "fill-extrusion-height": ["get", "height"],
            "fill-extrusion-base": ["get", "baseHeight"]
          },
          layout: {
          }
      });
    }
    
    /*
    console.log(waterarea);
    
    //水域
    if(waterarea){
      if(map.getLayer('waterarea-fillextrusion')){
          map.removeLayer('waterarea-fillextrusion');
      }
      map.getSource('waterarea3d').setData(
          waterarea
      );
      map.addLayer({
          id: 'waterarea-fillextrusion',
          type: 'fill-extrusion',
          source: 'waterarea3d',
          paint: {
            'fill-extrusion-color': 'rgb(190,210,255)',
            "fill-extrusion-height": ["get", "alti"],
            "fill-extrusion-base": ["-", ["get", "alti"], 1]
          },
          layout: {
          }
      });
    }
    */
    

    //Custom(DeckGL)利用--------------------------------------------------
    //道路
    if(map.getLayer('path-layer-road')){
      map.removeLayer('path-layer-road');
    }
    const myRoadDeckLayer = new MapboxLayer({
      type: PathLayer,
      id: 'path-layer-road',
      data: road,
      pickable: true,
      widthScale: 3,
//      widthMinPixels: 2,
      getPath: d => d.path,
      getColor: d => d.properties["color"],
      getWidth: d => d.properties["width"]
    });
    
    //鉄道
    if(map.getLayer('path-layer-railway')){
      map.removeLayer('path-layer-railway');
    }
    const myRailwayDeckLayer = new MapboxLayer({
      type: PathLayer,
      id: 'path-layer-railway',
      data: railway,
      pickable: true,
      widthScale: 3,
//      widthMinPixels: 2,
      getPath: d => d.path,
      getColor: d => [0,255,255],
      getWidth: d => 2
    });
    
    
    //等高線
    if(map.getLayer('path-layer-contour')){
      map.removeLayer('path-layer-contour');
    }
    const myContourDeckLayer = new MapboxLayer({
      id: 'path-layer-contour',
      type: PathLayer,
      data: contour,
      pickable: true,
      widthScale: 1,
      widthMinPixels: 1,
      getPath: d => d.path,
      getColor: d => [200,160,60],
      getWidth: d => 2
    });
    
    
    /*Path Layer*/
    map.addLayer(myRoadDeckLayer);
    map.addLayer(myRailwayDeckLayer);
    
    
    if(map.getZoom() >= 14){
      map.addLayer(myContourDeckLayer);
    }
}

//地形データ
var isTerrainShow = false;

var addTerrain = function(){
    if(isTerrainShow){
      //地形
      if(map.getLayer('terrain-layer')){
        map.removeLayer('terrain-layer');
      }
      const myTerrainDeckLayer = new MapboxLayer({
        id: 'terrain-layer',
        type: TerrainLayer,
        elevationDecoder: {
          rScaler: Math.pow(2,16)*0.01,
          gScaler: Math.pow(2,8)*0.01,
          bScaler: 0.01,
          offset: 0
        },
        elevationData: 'https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png',
        color: [100,100,100]
      });    
      map.addLayer(myTerrainDeckLayer);
    }else{
      if(map.getLayer('terrain-layer')){
        map.removeLayer('terrain-layer');
      }
    }
    
    isTerrainShow = !isTerrainShow;
}




</script>
 
</body>
</html>